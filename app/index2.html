<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body ng-app="MentionableApp">
    {{100.0000000000000 | number:2}}
    <textarea vp-mentionable=""></textarea>
</body>
<script src="assets/js/angular.min.js"></script>
<script src="assets/js/lodash.min.js"></script>
<script>
    angular.module('MentionableApp', [])
    .directive('vpMentionable', ['$sce', '$compile', function($sce, $compile) {
        return {
            restrict: 'A',
            require: '?ngModel',
            replace: true,
            templateUrl: 'VpMentionable.html',
            link: function(scope, element, attrs, ngModel) {
                // if (!ngModel) return;

                scope.users = [
                    {name: 'Alex Adams'},
                    {name: 'Alex Dunce'},
                    {name: 'Alexander Smith'},
                    {name: 'David Schmavid'},
                    {name: 'Wilson Alexander'}
                ];

                var keyboardMap = {
                    '13': {
                        action: function(event) {
                            event.preventDefault();

                            mentionableElement.html(mentionableElement.html() + '<br/>\u00a0');

                            setCaretPosition(getCaretPosition());
                        }
                    }
                };

                scope.mentions = window.mentions = [];

                scope.currentMention = null;

                var currentTagPosition = false;
                var currentCaretPosition = false;
                var mentionableElement = element.find('div');
                var currentSelection = false;

                console.log(mentionableElement);

                mentionableElement.triggerHandler('focus');

                if (document.selection) {
                    sel = document.selection.createRange();
                    sel.select();
                }

                mentionableElement.on('keydown click', function(event) {
                    keyboardMap[event.keyCode] && keyboardMap[event.keyCode].action(event);

                    getCurrentMention();
                });

                function getCurrentMention() {
                    var mentionName;

                    currentCaretPosition = getCaretPosition();

                    var tagSearchContext = mentionableElement.text().substr(0, currentCaretPosition);

                    currentTagPosition = tagSearchContext.lastIndexOf('@');

                    if (currentTagPosition < 0) {
                        scope.currentMention = null;

                        scope.$apply();

                        return false;
                    }

                    var mentionSearchContext = mentionableElement.text().substr(currentTagPosition + 1);

                    var mention = _.filter(scope.mentions, function(currentMention) {
                        if (currentCaretPosition - currentTagPosition > currentMention.name.length) {
                            return false;
                        }

                        return mentionSearchContext.substring(0, currentMention.name.length) === currentMention.name;
                    });

                    if (!mention.length) {
                        mentionName = tagSearchContext.substr(currentTagPosition + 1, currentCaretPosition);
                    } else {
                        mentionName = mention[0].name;
                    }

                    console.log(mentionName);

                    scope.currentMention = mentionName;

                    scope.$apply();
                }

                function getCaretPosition() {
                    if (document.selection) {
                        var sel = currentSelection = document.selection.createRange();
                        var selLen = document.selection.createRange().text.length;

                        sel.moveStart('character', -mentionableElement.text().length);

                        return sel.text.length - selLen;
                    } else if (window.getSelection) {
                        sel = window.getSelection();

                        if (sel.rangeCount) {
                            range = sel.getRangeAt(0).cloneRange().endOffset;
                        }
                    }

                    return range || 0;
                }

                function setCaretPosition(index) {
                    mentionableElement[0].focus();

                    if (document.selection) {
                        sel = document.selection.createRange();
                        sel.moveStart('character', -(mentionableElement.text().length - index));
                        sel.moveEnd('character', -(mentionableElement.text().length - index));
                        sel.select();
                    } else {
                        sel = window.getSelection();
                        sel.collapse(mentionableElement[0].firstChild, index);
                    }
                }

                function formatMention(mention) {
                    return '@' + mention.name + ' ';
                }

                function addMention(mention) {
                    var existingMention = _.find(scope.mentions, function(currentMention) {
                        return currentMention.name === mention.name;
                    });

                    if (!existingMention) scope.mentions.push(mention);
                }

                function replaceCurrentMention(mention) {
                    var previousText = mentionableElement.text();

                    var mentionText = formatMention(mention);

                    mentionableElement.text(previousText.substr(0, currentTagPosition) + mentionText + previousText.substr(currentTagPosition + scope.currentMention.length + 1));

                    scope.currentMention = false;

                    setCaretPosition(currentTagPosition + mentionText.length);

                    addMention(mention);
                }

                function read() {
                    var html = mentionableElement.text();

                    ngModel.$setViewValue(html);
                }

                scope.mention = replaceCurrentMention;
            }
        }
    }]);
</script>
</html>